[phases.setup]
# Install PostgreSQL client for database operations
aptPkgs = ['postgresql-client']

[phases.install]
# Install dependencies with production optimizations, skip optional deps that cause build issues
cmds = [
  'rm -rf node_modules package-lock.json || true',
  'npm install --include=dev --omit=optional',
  'node fix-rollup.js || echo "Rollup fix failed, continuing..."'
]

[phases.build]
# Build frontend and prepare backend for production
cmds = [
  'ROLLUP_USE_WASM=true npm run build --workspace @mawu/web',
  'npm run build:server',
  'npm run db:push:production',
  'npm run seed:admin:production'
]

[start]
# Start production server
cmd = 'npm run start:production'

[variables]
# Ensure production environment
NODE_ENV = 'production'
# Specify Node.js version
NIXPACKS_NODE_VERSION = '20'
# Force Rollup to use WASM instead of native binaries
ROLLUP_USE_WASM = 'true'
