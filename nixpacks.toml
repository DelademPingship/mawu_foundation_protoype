[phases.setup]
# No additional packages needed for static deployment
aptPkgs = []

[phases.install]
# Install dependencies including dev dependencies for build
cmds = [
  'rm -rf node_modules package-lock.json || true',
  'npm install --include=dev',
  'node fix-rollup.js || echo "Rollup fix failed, continuing..."'
]

[phases.build]
# Build frontend for static deployment (skip backend for demo)
cmds = [
  'node fix-rollup.js || echo "Rollup fix retry..."',
  'ROLLUP_USE_WASM=true npm run build --workspace @mawu/web',
  'echo "Build complete, checking output..."',
  'ls -la apps/web/dist/ || echo "Dist directory not found!"',
  'test -f apps/web/dist/index.html && echo "✅ index.html found" || echo "❌ index.html missing!"'
]

[start]
# Serve static files from the built frontend
cmd = 'node serve-static.js'

[variables]
# Ensure production environment
NODE_ENV = 'production'
# Specify Node.js version
NIXPACKS_NODE_VERSION = '20'
# Force Rollup to use WASM instead of native binaries
ROLLUP_USE_WASM = 'true'
